
<link   href="/Javascript/bootstrap/datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" />        
<script src="/Javascript/bootstrap/datetimepicker/moment.min.js" type="text/javascript"></script> 
<script src="/Javascript/bootstrap/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script> 

<script type="text/javascript">
    var tbot = angular.module("tbot");
    
    tbot.controller("TMUser", function($scope,$http)
        {   
            scope = $scope;
            $scope.dataLoaded = false;
            $("#txtEmail").focus();	
            $scope.update = function(userData)
                {                
                    $scope.result = " ... saving user";
            
                    var picker = $('#expirationDate').datetimepicker();

                    var selectedDate = picker.data('DateTimePicker').getDate();

                    userData.ExpirationDate = "\/Date(" + Date.parse(selectedDate) + ")\/";
                
                    $http.put('/rest/user',userData)
                        .success(function(data)
                            {    
                                $scope.result = (data) ? "(User details saved)" : "Error: Failed to Save user!";                                
                                $scope.userEnabled = userData.UserEnabled;
                            });
                };

            var userName = window.location.search.substring(1);
            if (userName != "")
            {
                    $scope.userName = userName;
                                        
                    $http.get('/rest/user/' + userName).success(function(data)
                        {
                            $scope.loadingMessage = "";
                            if (data=== "")
                            {
                                $scope.userData = { UserName :  "No user found with provided UserName!!!" };
                            }
                            else
                            {
                                $scope.userData = data;

                                var currentExpirationDate = new Date(parseInt($scope.userData.ExpirationDate.replace("/Date(", "").replace(")/",""), 10));

                                var picker = $('#expirationDate').datetimepicker();
                                var dateTimePicker = picker.data('DateTimePicker');
                                dateTimePicker.setDate(currentExpirationDate);
                                
                                $scope.dataLoaded = true;
                                $scope.userEnabled = data.UserEnabled;
                            }
                        });        
            }
            else        
                $scope.userData = { UserName :  "No user found with provided UserName!!!" };
		
            $scope.deleteUser = function()
                {
                    $scope.userDeleted = true;
                };
		    $('#expirationDate').datetimepicker({
		      pickTime:false
		    });
            
            $scope.loadingMessage = "Loading user data";
            $scope.userDeleted = false;
            $scope.deleteButtonEnabled = false;
        });

</script>

<style>
    .form-group {
                        margin-top    : 5px;
                        margin-bottom : 5px;
                   }
</style>
<div ng-controller="TMUser">
  
    <a href="User_View?user={{userName}}" class="btn btn-info" >View User</a>
    <a href="User_Edit?{{userName}}" class="btn btn-info" disabled>Edit User</a>
    <a href="User_Activities?user={{userName}}" class="btn btn-info" >View Activity/Logs</a>
    <a href="User_Raw?user={{userName}}">Raw/Xml Data</a>

    <h4>Editing user </h4>
    
    <div ng-show="userDeleted">
        <b>User {{userData.UserName}} will be deleted when this is implemented :)</b>
    </div>
    <div ng-class="{ 'bg-danger' : userEnabled ==false }" ng-show="userDeleted == false"> 
        <form name="myForm" class="form-horizontal" role="form">      <!-- change this form to be a directive-->        

            <div class="form-group">
                <label class="col-sm-2 control-label">User ID</label>
                <div class="col-sm-6">
                    <p class="form-control-static">{{userData.UserId}}{{loadingMessage}}</p>
                </div>
            </div>
       
            <div class="form-group">
                <label  class="col-sm-2 control-label">UserName</label>
                <div class="col-sm-6">
                    <input class="form-control" type="text" ng-model="userData.UserName" required ng-disabled="true"/>
                </div>
            </div>

            <div class="form-group">
                <label  class="col-sm-2 control-label">Email</label>
                <div class="col-sm-6">
                    <input class="form-control" type="email" id="txtEmail" name="txtEmail" ng-model="userData.Email" required/>
                </div>
                <div class="col-sm-3">
                    <span style="color:red;font-weight:bold" ng-show="dataLoaded && myForm.txtEmail.$error.required">This field is required!</span>
                    <span style="color:red;font-weight:bold" ng-show="myForm.txtEmail.$error.email">Email is invalid!</span>
                </div>
            </div>
        
            <div class="form-group">
                <label class="col-sm-2 control-label">FirstName</label>
                <div class="col-sm-6">
                    <input class="form-control"      ng-model="userData.FirstName"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">LastName</label>
                <div class="col-sm-6">
                    <input class="form-control" ng-model="userData.LastName"/>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Company</label>
                <div class="col-sm-6">
                    <input class="form-control" ng-model="userData.Company"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Job/Title</label>
                <div class="col-sm-6">
                    <input class="form-control" ng-model="userData.Title"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Country</label>
                <div class="col-sm-6">
                    <input class="form-control" ng-model="userData.Country"/>
                </div>
            </div>
            
            <div class="form-group">
                <label class="col-sm-2 control-label">State</label>
                <div class="col-sm-6">
                    <input class="form-control" ng-model="userData.State"/>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Expires at:</label>
                <div class="col-sm-6">
                    <div class='input-group date' id='expirationDate' data-date-format='MMM/DD/YYYY'>
                        <input type='text' class="form-control" readonly/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                    </div>
                </div>
            </div>               
            <div class="form-group">                
                <div class="col-sm-offset-2  col-sm-2">
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" ng-model="userData.UserEnabled"/> User Enabled
                        </label>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" ng-model="userData.AccountNeverExpires"/> Never expires
                        </label>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" ng-model="userData.PasswordExpired"/> Password Expired
                        </label>
                    </div>
                </div>
            </div>        
            <br />
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-6">
                                  
                    <button class="btn btn-primary" ng-disabled="myForm.$invalid" ng-click="update(userData)">
                        Save User
                    </button>  
                    <span class="result">{{result}}</span>                                            
                
                </div>
            </div>
            <br />
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-1">                
                    <button class="btn btn-danger" ng-disabled="deleteButtonEnabled===false" ng-click="deleteUser()">
                        Delete
                    </button> 
                </div>
                <div class="col-sm-5">                
                    <div class="checkbox">                                                            
                        <input type="checkbox" ng-model="deleteButtonEnabled"/> Enable Delete Button
                    </div>
                </div>
            </div>               
            <br/>                    
        </form> 
        <br/>            
    </div>


    <pre>
        {{userData}}
    </pre>

</div>

<hr/>
<a href="Current_Users">back to users list</a>